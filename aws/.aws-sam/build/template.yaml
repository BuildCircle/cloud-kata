AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'devops-test

  Sample SAM Template for devops-test

  '
Globals:
  Function:
    Timeout: 3
Resources:
  BuildCircleHandler:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: BuildCircle
      Handler: app.buildCircleHandler
      Runtime: nodejs14.x
      Events:
        SNSRecieved:
          Type: SNS
          Properties:
            Topic:
              Ref: SNSBuildCircleTopic
      CodeUri: BuildCircleHandler
  BuildCircleInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: BuildCircleHandler
      Principal: sns.amazonaws.com
  SNSBuildCircleTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName:
        Fn::Sub: SNSBuildCircleTopic
      TopicName:
        Fn::Sub: SNSBuildCircleTopic
      Subscription:
      - Protocol: lambda
        Endpoint:
          Fn::GetAtt:
          - BuildCircleHandler
          - Arn
  SNSBuildCircleTopicPolicy:
    Type: AWS::SNS::TopicPolicy
    Properties:
      Topics:
      - Ref: SNSBuildCircleTopic
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action: sns:Publish
          Resource:
            Ref: SNSBuildCircleTopic
          Principal: '*'
  AlarmSNSTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: AlarmTopic
      Subscription:
      - Protocol: email
        Endpoint: mario.garciapinan@buildcircle.co.uk
  Alarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: onErrorAlarm
      AlarmActions:
      - Ref: AlarmSNSTopic
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
      - Name: FunctionName
        Value:
          Ref: BuildCircleHandler
      EvaluationPeriods: 1
      MetricName: Errors
      Namespace: AWS/Lambda
      Period: 60
      Statistic: Sum
      Threshold: '1'
